
DROP TABLE IF EXISTS  #fltCOVID;
--Patient has an encounter with a particular EDG diagnosis ID 
SELECT distinct PD.PrimaryMrn mrn, ef.EncounterEpicCsn, ef.EncounterKey,'Diagnosis' SOURCE  INTO #fltCOVID
FROM DiagnosisEventFact def 
		JOIN DIAGNOSISDIM dd  on (def.DiagnosisKey = dd.DiagnosisKey)
		JOIN ENcounterFact ef on (def.EncounterKey = ef.EncounterKey)
		JOIN PatientDim pd on (pd.DurableKey = ef.PatientDurableKey and pd.IsCurrent = 1 and pd.IsValid = 1)
		JOIN DiagnosisTerminologyDim dtd on (dtd.DiagnosisKey = dd.DiagnosisKey)
		WHERE dd.DiagnosisEpicId in 
	   (1494811718,1494811719,1494811720,1494811721,1494811722,1494811735,1494811736,1494811737,1494811738,1494811739,1494811740,1494811743,1494811744,
		1494811745,1494811752,1494811753,1494811754,1494814600,1494816040,1494816041,1494816042,1494816043,1494816044,1494804919,1494804920,1494804921,
		1494804922,1494804937,1494804938,1494804939,1494804940,1494804941,1494805985,1494805988,1494805990,1494805991,1494805996,1494805997,1494810712,
		1494810720,1494810733,1494811348,1494811349,1494811350,1494811351,1494811352,1494811374,1494811375,1494811376,1494811378,1494811379,1494811381,
		1494811382,1494811383,1494811384,1494811388,1494811390,1494811392,1494811393,1494811394,1494811398,1494811399,1494811400,1494811402,1494811404,
		1494811405,1494811407,1494811436,1494811570,1494811571,1494811572,1494811625,1494811626,1494811629,1494811630,1494811631,1494811633,1494811634,
		1494811635,1494811636,1494811637,1494811638,1494811639,1494811640,1494811641,1494811642,1494811643,1494811644,1494811645,1494811646,1494811649,
		1494811650,1494811651,1494811652,1494811653,1494811654,1494811655,1494811656,1494811657,1494811658,1494811659,1494811660,1494811661,1494811663,
		1494811668,1494811669,1494811673,1494811674,1494811675,1494811676,1494811677,1494811678,1494811679,1494811680,1494811682,1494811683,1494811684,
		1494811688,1494811690,1494811692,1494811710,1494821577)
		OR dtd.Value = 'U07.1'
UNION
--Patient has an encounter with a particular Visit Type
SELECT distinct PD.PrimaryMrn mrn,ef.EncounterEpicCsn, ef.EncounterKey , 'Visit Type' 
FROM ENcounterFact ef INNER JOIN PatientDim pd on pd.DurableKey = ef.PatientDurableKey and pd.IsCurrent=1
WHERE ef.VisitType  like '%COVID%'
UNION
--Patient has a Lab Order for a SARS-CoV-2 lab test
SELECT DISTINCT PD.PrimaryMrn mrn, ef.EncounterEpicCsn, ef.EncounterKey, 'Lab Order'
FROM ProcedureOrderFact pof	INNER JOIN encounterfact ef	ON pof.EncounterKey = ef.EncounterKey
INNER JOIN PatientDim pd on pd.DurableKey = ef.PatientDurableKey and pd.IsCurrent=1
WHERE ProcedureKey IN (302762,302621)
UNION
--Patient has a Lab Order for a SARS-CoV-2 lab test
SELECT DISTINCT PD.PrimaryMrn mrn, ef.EncounterEpicCsn, ef.EncounterKey, 'Lab Order'
FROM LabTestFact ltf	INNER JOIN encounterfact ef	ON ltf.EncounterKey = ef.EncounterKey and ltf.ProcedureDurableKey IN (302762,302621)
INNER JOIN PatientDim pd on pd.DurableKey = ef.PatientDurableKey and pd.IsCurrent=1
UNION
--Patient has a Lab Test Result for a SARS-CoV-2 lab test
SELECT DISTINCT PD.PrimaryMrn mrn, ef.EncounterEpicCsn, ef.EncounterKey , 'Lab Result'
FROM encounterfact ef INNER JOIN LabComponentResultFact lcrf on ef.EncounterKey = lcrf.EncounterKey and lcrf.LabComponentKey in (29430,29432)
 INNER JOIN PatientDim pd on pd.DurableKey = ef.PatientDurableKey and pd.IsCurrent=1
 UNION
 -- DOH Test
SELECT distinct PD.PrimaryMrn mrn, ef.EncounterEpicCsn, ef.EncounterKey,'DOH Tests' SOURCE 
FROM   ENcounterFact ef INNER JOIN PatientDim pd on pd.DurableKey = ef.PatientDurableKey and pd.IsCurrent=1
and EncounterEpicCsn   in 
(123,345,678)  --********EncounterEpicCsn is PHI (Replace with required EncounterEpicCsn for MRNs from Department of Health) ********
UNION
--Positive COVID Antibody test
SELECT DISTINCT PD.PrimaryMrn, ef.EncounterEpicCsn, ef.EncounterKey , 'COVID Antibody Positive'
		             from LabComponentResultFact  lcrf
		                  join LabComponentDim lcd on (lcrf.LabComponentKey = lcd.LabComponentKey 
			                                and lcd.LabComponentEpicId in (32930, 32933, 33098, 32931)
											and lcrf.Value ='Positive'
											)
						  join EncounterFact ef on (ef.EncounterKey = lcrf.EncounterKey)
						  join PatientDim pd on (pd.DurableKey = ef.PatientDurableKey and pd.IsCurrent =1); 

---- MEDS
DROP TABLE IF exists #MED_NAMES;
SELECT	DISTINCT MedicationKey ,
		CASE WHEN MedicationKey IN (5249, 17248, 17676, 15809, 19356, 89810, 95081, 99654, 111957, 115883, 107072, 107147, 107180, 121054,
                             		121056, 121372, 121382, 120682, 120695, 111373, 125765, 125772, 123111, 123112, 124354, 124355, 124360,
									124361, 125970, 125971, 123929, 122734, 122735, 122736, 122737, 130387) THEN 'TOCILIZUMAB' 
			 WHEN MedicationKey IN (12474, 6604, 4108, 119166) THEN 'HYDROXYCHLOROQUINE'
			 WHEN MedicationKey IN (121676, 121677, 124398, 124399, 124400, 124401, 121420, 121421, 130383) THEN 'SARILUMAB'
			 WHEN MedicationKey IN (130379, 130398, 130400)  THEN 'REMDESIVIR'
			 WHEN MedicationKey IN (11540, 19407, 130020) THEN 'ANAKINRA'
			 WHEN MedicationKey IN (3042, 7008, 8039, 11064, 14078, 5290, 9486, 13842, 491, 507, 4712, 4767, 13436, 4221, 10479, 3163, 9831,
                        			 10046, 32910, 44617, 71552, 81439, 83909, 95389, 101332, 30, 127639, 127645, 127646, 127647, 129910) THEN 'AZITHROMYCIN' 
	WHEN   MedicationKey IN (10323,13515,2977,125209,3601,17350,111215,17549,18885,125226,12875) THEN 'RIVAROXABAN' ---	rivaroxaban (Xarelto)
	WHEN   MedicationKey IN  (7936,10143,18887,19985,101639,123651,98148,123654)  THEN 'APIXABAN'   ----apixaban (Eliquis)	
	WHEN   MedicationKey IN   (10335,12144,5059,6224,8467,12906,524,14741,4343,13129,43489,7753,12736,13254,7601) THEN 'ENOXAPARIN'   ---- enoxaparin (Lovenox)
    WHEN	MedicationKey IN (2453,16642,18988,18248,10542,17617,12673,3715,18292,123465,124135,124134,40988,17933,20637,124555,124556,123484)
	                          THEN 'Tissue Plasminogen Activator'   ----	Tissue Plasminogen Activator (tPA)	   	
		 WHEN MedicationKey IN (5324,15023, 7530, 11463, 7837, 10222, 4708, 14688, 2955, 119596, 15061, 10454, 17785, 19567, 9576, 8318, 
								19629, 121713, 3120, 126085, 1727, 6370, 2715, 126138, 3189, 122603, 4782, 123090, 80140, 120562, 123091, 68196, 2589, 123088, 
								121915, 18210, 652, 17455, 125959, 78213, 124929, 66726, 17784, 121988, 122589, 18774, 123238, 123089, 121987, 10895, 17271, 6144, 
								19587, 125958, 14199, 125796, 16055, 110447, 43293, 53861, 18913, 10190, 89093, 115881, 124928, 127255, 84581, 86781, 110208, 15563,
								18870, 20331, 126368, 72480, 97180, 125194, 53443, 71157, 113448, 113146, 73733, 88167, 116904, 67430, 37949, 124927, 102725, 25331,
								50101, 69727, 90649, 118625, 16752, 37831, 15853, 85579, 82373, 78263)   THEN 'Heparin'   ----	 'Heparin' 
						WHEN MedicationKey IN 		(15184, 7927, 14379, 122436, 51123, 4912, 4500, 15634, 15769) THEN 'ETANERCEPT' -- ETANERCEPT(Enbrel)
                        
        WHEN  MedicationKey IN (5175, 17578, 12266, 2545, 18959, 17281, 122654, 16722, 96798) THEN   'DOPAMINE'
WHEN  MedicationKey IN (99784, 125719, 122663, 125824, 1337, 2882, 126622, 122565, 6839) THEN   'VASOPRESSIN (VASOSTRICT)'
WHEN  MedicationKey IN (8400, 12995, 15395, 9203, 126621, 94225, 7483) THEN   'NOREPINEPHRINE (LEVOPHED)'
WHEN  MedicationKey IN (3462, 116504, 120187, 8457, 12467, 112212, 9700, 122632, 115344) THEN   'EPINEPHRINE'
WHEN  MedicationKey IN (725, 7776, 975, 11510, 17175, 3520, 54036, 53404) THEN   'MILRINONE'
WHEN  MedicationKey IN (13405, 18741, 11508, 3816, 8040, 13218, 122653, 36765) THEN   'DOBUTAMINE'
WHEN  MedicationKey IN (110744, 106119, 7075, 776, 91581, 121761, 1384) THEN   'PHENYLEPHRINE'
WHEN  MedicationKey IN (6292, 613, 8437, 3694, 15065, 10042, 10207, 22, 4578, 4367, 13076, 9863, 12311, 167, 12146, 3493, 11008, 6706, 12299, 13384, 11374, 43460, 53506, 65037, 123862, 121755, 100078, 14710, 53166, 7291, 13361) THEN   'METHYLPREDNISOLONE'
WHEN  MedicationKey IN (190, 11899, 11982, 3856, 5541, 2847, 54984, 7304, 12163, 12013, 17970, 17028, 3599, 17595, 59105) THEN   'PREDNISONE'
WHEN  MedicationKey IN (12226, 12552, 13795, 15012, 14463, 6076, 13458, 118102, 118101, 9998, 3327, 7907, 5731, 1209, 118358, 118103, 58714, 3581, 118100, 58312, 123861, 115330, 12368, 124440, 126185) THEN   'DEXAMETHASONE'
WHEN MedicationKey IN (15481, 1034, 13844, 11978, 15322, 49535, 12589, 100921, 19092, 18636, 8911, 18524, 20695, 16140)    THEN  'PREDNISOLONE'
WHEN MedicationKey IN (355, 1891 ,2055, 5794, 9025, 9349, 14628, 15068, 22909, 40806, 41717, 42935, 45221, 122576, 130433, 130439)    THEN  'HYDROCORTISONE'
WHEN MedicationKey IN (11338, 2514, 12, 6045, 1470, 9795, 9211, 15392, 6422, 52246, 2134, 64897, 11250, 73638, 52337, 13668, 3700, 74268, 52230, 1013, 122932, 71270, 19304) THEN 'FAMOTIDINE'
WHEN MedicationKey IN (22668,4001, 14319, 16161, 1137, 16310, 18821, 8382, 39468, 19270) THEN 'CYCLOPHOSPHAMIDE'
WHEN MedicationKey IN (6587, 6818, 1754, 14059, 118218) THEN 'ANTI-THYMOCYTE GLOBULIN'
WHEN MedicationKey IN (2118, 18686, 112788, 107703, 110367, 112957) THEN 'EDOXABAN'
WHEN MedicationKey IN (8987, 8232, 118084, 16956, 1949, 8220, 118085) THEN 'DABIGATRAN'
WHEN MedicationKey IN (17730, 1945, 93281, 17389, 13879) THEN 'ARGATROBAN'
WHEN MedicationKey IN (7988, 5008, 11977, 675, 6776, 10959, 7457, 2656, 5323, 11323, 10294, 4469, 2447, 13566, 9860, 4921, 7184, 4345, 4119, 3096, 7799, 12521, 35513, 51122, 39055, 35502, 19307, 35522, 37379, 122556, 79317, 122557, 47895, 3069, 27522) THEN 'WARFARIN (COUMADIN)'
WHEN MedicationKey IN (847, 63201, 123668, 117301, 119889, 14864, 124168, 57521) THEN 'BETAMETHASONE (CELESTONE)'
WHEN MedicationKey IN (120884, 120916, 120914, 120918) THEN 'DEFLAZACORT'

                        
		END AS MEDICATION_NAME
		INTO #MED_NAMES
FROM	MedicationDim MD 
WHERE	MD.NAME is not null
and	  MedicationKey  IN (5249, 17248, 17676, 15809, 19356, 89810, 95081, 99654, 111957, 115883, 107072, 107147, 107180, 121054, 121056, 121372, 121382, 120682, 120695, 111373, 125765, 125772, 123111, 123112, 124354, 124355, 124360, 124361, 125970, 125971, 123929, 122734, 122735, 122736, 122737, 130387,
						   12474, 6604, 4108, 119166,
						   121676, 121677, 124398, 124399, 124400, 124401, 121420, 121421, 130383,
						   130379, 130398, 130400,
						   11540, 19407, 130020,
						   3042, 7008, 8039, 11064, 14078, 5290, 9486, 13842, 491, 507, 4712, 4767, 13436, 4221, 10479, 3163, 9831, 10046, 32910, 44617, 71552, 81439, 83909, 95389, 101332, 30, 127639, 127645, 127646, 127647, 129910 ,
						   
						   10323,13515,2977,125209,3601,17350,111215,17549,18885,125226,12875 , ---	rivaroxaban (Xarelto)    , apixaban (Eliquis) , and enoxaparin (Lovenox) medication
	 7936,10143,18887,19985,101639,123651,98148,123654 , ----apixaban (Eliquis)	
	 10335,12144,5059,6224,8467,12906,524,14741,4343,13129,43489,7753,12736,13254,7601     ---- enoxaparin (Lovenox)
						   
			 ,2453,16642,18988,18248,10542,17617,12673,3715,18292,123465,124135,124134,40988,17933,20637,124555,124556,123484 	  -------	Tissue Plasminogen Activator (tPA)	 			   

,5324,15023, 7530, 11463, 7837, 10222, 4708, 14688, 2955, 119596, 15061, 10454, 17785, 19567, 9576, 8318, 
19629, 121713, 3120, 126085, 1727, 6370, 2715, 126138, 3189, 122603, 4782, 123090, 80140, 120562, 123091, 68196, 2589, 123088, 
121915, 18210, 652, 17455, 125959, 78213, 124929, 66726, 17784, 121988, 122589, 18774, 123238, 123089, 121987, 10895, 17271, 6144, 
19587, 125958, 14199, 125796, 16055, 110447, 43293, 53861, 18913, 10190, 89093, 115881, 124928, 127255, 84581, 86781, 110208, 15563,
18870, 20331, 126368, 72480, 97180, 125194, 53443, 71157, 113448, 113146, 73733, 88167, 116904, 67430, 37949, 124927, 102725, 25331,
50101, 69727, 90649, 118625, 16752, 37831, 15853, 85579, 82373, 78263,   ----	 'Heparin' 
15184, 7927, 14379, 122436, 51123, 4912, 4500, 15634, 15769 --etanercept (Enbrel)

,	5175, 17578, 12266, 2545, 18959, 17281, 122654, 16722, 96798	 -----	Dopamine
,	99784, 125719, 122663, 125824, 1337, 2882, 126622, 122565, 6839	 -----	vasopressin (Vasostrict)
,	8400, 12995, 15395, 9203, 126621, 94225, 7483	 -----	norepinephrine (Levophed)
,	3462, 116504, 120187, 8457, 12467, 112212, 9700, 122632, 115344	 -----	Epinephrine
,	725, 7776, 975, 11510, 17175, 3520, 54036, 53404	 -----	Milrinone
,	13405, 18741, 11508, 3816, 8040, 13218, 122653, 36765	 -----	Dobutamine
,	110744, 106119, 7075, 776, 91581, 121761, 1384	 -----	Phenylephrine

,	6292, 613, 8437, 3694, 15065, 10042, 10207, 22, 4578, 4367, 13076, 9863, 12311, 167, 12146, 3493, 11008, 6706, 12299, 13384, 11374, 43460, 53506, 65037, 123862, 121755, 100078, 14710, 53166, 7291, 13361	 -----	Methylprednisolone	
,	190, 11899, 11982, 3856, 5541, 2847, 54984, 7304, 12163, 12013, 17970, 17028, 3599, 17595, 59105	 -----	Prednisone	
,	12226, 12552, 13795, 15012, 14463, 6076, 13458, 118102, 118101, 9998, 3327, 7907, 5731, 1209, 118358, 118103, 58714, 3581, 118100, 58312, 123861, 115330, 12368, 124440, 126185	 -----	Dexamethasone	
, 15481, 1034, 13844, 11978, 15322, 49535, 12589, 100921, 19092, 18636, 8911, 18524, 20695, 16140 ------ 'PREDNISOLONE'   
, 355, 1891 ,2055, 5794, 9025, 9349, 14628, 15068, 22909, 40806, 41717, 42935, 45221, 122576, 130433, 130439 ------ 'HYDROCORTISONE'
,11338, 2514, 12, 6045, 1470, 9795, 9211, 15392, 6422, 52246, 2134, 64897, 11250, 73638, 52337, 13668, 3700, 74268, 52230, 1013, 122932, 71270, 19304 -----'FAMOTIDINE'
,22668,4001, 14319, 16161, 1137, 16310, 18821, 8382, 39468, 19270 -- 'CYCLOPHOSPHAMIDE'
,6587, 6818, 1754, 14059, 118218 --'ANTI-THYMOCYTE GLOBULIN'
,2118, 18686, 112788, 107703, 110367, 112957 -- 'EDOXABAN'
,8987, 8232, 118084, 16956, 1949, 8220, 118085 --  'DABIGATRAN'
,17730, 1945, 93281, 17389, 13879 -- 'ARGATROBAN'
,7988, 5008, 11977, 675, 6776, 10959, 7457, 2656, 5323, 11323, 10294, 4469, 2447, 13566, 9860, 4921, 7184, 4345, 4119, 3096, 7799, 12521, 35513, 51122, 39055, 35502, 19307, 35522, 37379, 122556, 79317, 122557, 47895, 3069, 27522 -- 'WARFARIN (COUMADIN)'
,847, 63201, 123668, 117301, 119889, 14864, 124168, 57521 -- 'BETAMETHASONE (CELESTONE)'
,120884, 120916, 120914, 120918 -- 'DEFLAZACORT'
);



DROP TABLE IF EXISTS #TEMP_COVID_MED;
SELECT	DISTINCT C.MRN, E.EncounterEpicCsn, C.EncounterKey, e.date ENCOUNTERDATE ,
		F.AdministrationDateKey AS MED_DATE,upper ( MEDICATION_NAME )  MEDICATION_NAME
		,m.GenericName  GENERIC_NAME
,m.STRENGTH
,m.FORM  
,f.ROUTE
,cast (f.MinimumDose as varchar(30))   DOSE
,f.DoseUnit  DOSE_UOM
,case when f.type = 'Medication Order with Administration' then f.StartInstant end  as Administration_Date
,f.mode,
case when f.type = 'Medication Order' then f.StartInstant end  as order_Date
INTO #TEMP_COVID_MED
FROM	#fltCOVID C 
INNER JOIN EncounterFact E ON (C.EncounterEpicCsn = E.EncounterEpicCsn)
INNER JOIN MedicationEventFact F ON (E.EncounterKey = F.EncounterKey )
INNER JOIN MedicationDim M ON (F.MEDICATIONKEY = M.MEDICATIONKEY)
INNER JOIN #MED_NAMES Md ON (F.MEDICATIONKEY = Md.MEDICATIONKEY)
and md.MEDICATION_NAME not in  ( 'Heparin' ,'Tissue Plasminogen Activator')
union
SELECT	DISTINCT C.MRN, E.EncounterEpicCsn, C.EncounterKey, e.date ENCOUNTERDATE ,
		F.AdministrationDateKey AS MED_DATE,upper ( MEDICATION_NAME )  MEDICATION_NAME
		,m.GenericName  GENERIC_NAME
,m.STRENGTH
,m.FORM  
,f.AdministrationRoute  ROUTE
, cast (f.Dose  as varchar (30) )  Dose
,f.DoseUnit  DOSE_UOM
,f.AdministrationInstant Administration_Date
,mo.mode
,mo.OrderedInstant order_date
FROM	#fltCOVID C 
JOIN EncounterFact E ON (C.EncounterEpicCsn = E.EncounterEpicCsn)
JOIN medicationadministrationfact F ON (E.EncounterKey = F.EncounterKey )
JOIN MedicationDim M ON (F.MEDICATIONKEY = M.MEDICATIONKEY)
JOIN #MED_NAMES Md ON (F.MEDICATIONKEY = Md.MEDICATIONKEY)
join MedicationOrderFact mo on (f.MedicationOrderKey=mo.MedicationOrderKey)
and md.MEDICATION_NAME   in  ( 'Heparin' ,'Tissue Plasminogen Activator')
union
SELECT distinct  co.mrn, co.EncounterEpicCsn, FSD.EncounterKey,ef.date ,'', FlowsheetRowDim.DisplayName ,FlowsheetRowDim.DisplayName ,'','','',
CAST(FSD.NumericValue AS NVARCHAR(99)) ,'',	  
	  CAST( measdate.DateValue AS DATETIME ) + CAST( meastime.TimeValue AS DATETIME ) MeasurementInstant,
	  'Inpatient',	  cast (null as datetime) 
  FROM FlowsheetValueFact fsd INNER JOIN #fltCOVID CO ON fsd.EncounterKey = CO.EncounterKey
  INNER JOIN FlowsheetRowDim   ON fsd.FlowsheetRowKey = FlowsheetRowDim.FlowsheetRowKey and flowsheetrowepicid = '888316210'
  	  inner join FlowsheetTemplateDim td on fsd.FlowsheetTemplateKey = td.FlowsheetTemplateKey and td.FlowsheetTemplateEpicId = '88931513'
	  inner join EncounterFact ef on ef.EncounterKey = fsd.EncounterKey
	   INNER JOIN DateDim measdate      ON FSD.DateKey = measdate.DateKey
      INNER JOIN TimeOfDayDim meastime    ON FSD.TimeOfDayKey = meastime.TimeOfDayKey
	  WHERE FSD.NumericValue IS NOT NULL;

select  
MRN
,    ENCOUNTER_EPIC_CSN
,   Encounter_Date
,  Administration_Date
,  Medication_NAME
, GENERIC_NAME
, STRENGTH
, FORM
, ROUTE
,   DOSE
,  DOSE_UOM,
case when mode = 'Inpatient' then 'Medication_Administration' when mode =  'Outpatient' then 'Outpatient_Medication_Order' end as RECORD_TYPE,
 order_date   
from 
(
select distinct  
  MRN
, ENCOUNTEREPICCSN  ENCOUNTER_EPIC_CSN
, EncounterDate Encounter_Date
,  Administration_Date
,  Medication_NAME
, GENERIC_NAME
, STRENGTH
, FORM
, ROUTE
,   DOSE
,  DOSE_UOM,
mode, 
 order_date,
 row_number () over (partition by mrn  ,encounterepiccsn, administration_date,medication_name 
order by  mrn  ,encounterepiccsn, administration_date,medication_name, GENERIC_NAME desc
  ) rnk
from  #TEMP_COVID_MED c
)flt 
where 
flt.rnk  = 1; 